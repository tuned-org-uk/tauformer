name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  tests:
    runs-on: "${{ matrix.platform.os }}-latest"
    strategy:
      matrix:
        platform:
          [
            { os: "windows", target: "x86_64-pc-windows-msvc", backend: "cpu" },
            { os: "ubuntu", target: "x86_64-unknown-linux-gnu", backend: "cpu" },
            { os: "macos", target: "aarch64-apple-darwin", backend: "wgpu" },
          ]
    env:
      # Use the matrix value directly in steps
      BACKEND_FEATURE: ${{ matrix.platform.backend }}
      TZ: "/usr/share/zoneinfo/UTC" # Fixed TZ path to be valid generic UTC

    steps:
      # --- Cleanup Steps (Kept as is) ---
      - name: Free Disk Space (Ubuntu)
        if: matrix.platform.os == 'ubuntu'
        uses: jlumbroso/free-disk-space@main
        with:
          tool-cache: false
          android: true
          dotnet: true
          haskell: true
          large-packages: true
          docker-images: true
          swap-storage: true

      - name: Free Disk Space (macOS)
        if: matrix.platform.os == 'macos'
        run: |
          df -h
          sudo rm -rf /Users/runner/Library/Android
          sudo rm -rf /usr/local/share/boost
          sudo rm -rf /usr/local/lib/node_modules
          brew cleanup
          df -h

      - name: Free Disk Space (Windows)
        if: matrix.platform.os == 'windows'
        run: |
          Get-PSDrive -PSProvider FileSystem | Select-Object Name, @{Name="Used(GB)";Expression={[math]::Round($_.Used/1GB,2)}}, @{Name="Free(GB)";Expression={[math]::Round($_.Free/1GB,2)}}, @{Name="Total(GB)";Expression={[math]::Round(($_.Used+$_.Free)/1GB,2)}} | Format-Table
          Remove-Item -Path "C:\hostedtoolcache\windows\*" -Recurse -Force -ErrorAction SilentlyContinue
          if ($env:ANDROID_SDK_ROOT) { Remove-Item -Path "$env:ANDROID_SDK_ROOT" -Recurse -Force -ErrorAction SilentlyContinue }
          Remove-Item -Path "C:\Program Files\dotnet" -Recurse -Force -ErrorAction SilentlyContinue
          Remove-Item -Path "C:\ProgramData\chocolatey" -Recurse -Force -ErrorAction SilentlyContinue
        shell: powershell

      - uses: actions/checkout@v4

      # --- Setup Steps ---
      - name: Setup Protobuf (Cross-Platform)
        uses: arduino/setup-protoc@v3
        with:
          version: "25.x"
          repo-token: ${{ secrets.GITHUB_TOKEN }}

      # Explicit install mostly redundant with arduino/setup-protoc but kept for safety on Ubuntu
      - name: Install protoc (Ubuntu fallback)
        if: matrix.platform.os == 'ubuntu'
        run: |
          sudo apt-get update
          sudo apt-get install -y protobuf-compiler
          protoc --version

      - name: Cache Cargo registry and git sources
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
          key: ${{ runner.os }}-cargo-registry-${{ matrix.platform.target }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-cargo-registry-${{ matrix.platform.target }}-

      - name: Cache target build artifacts
        uses: actions/cache@v4
        with:
          path: |
            ./target/*/incremental/
            ./target/*/deps/
            ./target/*/.fingerprint/
          key: ${{ runner.os }}-target-${{ matrix.platform.target }}-${{ hashFiles('**/Cargo.toml') }}-${{ hashFiles('**/Cargo.lock') }}
          restore-keys: |
            ${{ runner.os }}-target-${{ matrix.platform.target }}-${{ hashFiles('**/Cargo.toml') }}-

      - name: Install Rust toolchain
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          target: ${{ matrix.platform.target }}
          profile: minimal
          default: true

      - name: Verify Protobuf
        run: protoc --version

      # --- Build & Test Logic ---
      
      # 1. Build with the platform-specific backend feature
      - name: Build with ${{ matrix.platform.backend }} feature
        uses: actions-rs/cargo@v1
        with:
          command: build
          # We use --no-default-features to strip 'cpu' if default, then add back specific one
          args: --no-default-features --features ${{ matrix.platform.backend }} --target ${{ matrix.platform.target }}

      # 2. Test with the same feature set
      - name: Run tests (${{ matrix.platform.backend }})
        uses: actions-rs/cargo@v1
        with:
          command: test
          args: --no-default-features --features ${{ matrix.platform.backend }} --target ${{ matrix.platform.target }}

      # 3. Clippy with the same feature set
      - name: Run clippy
        uses: actions-rs/cargo@v1
        with:
          command: clippy
          args: --no-default-features --features ${{ matrix.platform.backend }} --target ${{ matrix.platform.target }} -- -D warnings
